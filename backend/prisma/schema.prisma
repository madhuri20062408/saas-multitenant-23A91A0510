generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ========== Enums ==========

enum Role {
  SUPER_ADMIN
  TENANT_ADMIN
  USER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

// ========== Models ==========

model Plan {
  id          String   @id @default(cuid())
  name        String   @unique // free, pro, enterprise
  maxUsers    Int
  maxProjects Int
  tenants     Tenant[]
}

model Tenant {
  id        String    @id @default(cuid())
  name      String
  subdomain String    @unique
  plan      Plan      @relation(fields: [planId], references: [id])
  planId    String
  users     User[]
  projects  Project[]
  tasks     Task[]
  auditLogs AuditLog[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model User {
  id        String   @id @default(cuid())
  email     String
  password  String
  name      String
  role      Role
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  tenantId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // back relations
  createdProjects Project[]        @relation("ProjectCreatedBy")
  assignedTasks   Task[]
  auditLogs       AuditLog[]

  @@unique([email, tenantId]) // email unique per tenant; tenantId NULL for super admin
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String
  tasks       Task[]
  createdBy   User     @relation("ProjectCreatedBy", fields: [createdById], references: [id])
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  project     Project    @relation(fields: [projectId], references: [id])
  projectId   String
  assignee    User?      @relation(fields: [assigneeId], references: [id])
  assigneeId  String?
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  tenantId    String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([tenantId])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  tenantId  String?
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  details   String?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([tenantId])
}
